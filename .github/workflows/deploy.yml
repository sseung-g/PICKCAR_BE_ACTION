name: CI/CD Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) SSH 키 로드
      - name: Setup SSH agent
        uses: actions/ssh-agent@v0.7.2
        with:
          ssh-private-key: ${{ secrets.EC2_ACTIONS_SSH_KEY }}

      # 3) EC2로 접속 후 배포 스크립트 실행
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/PICKCAR_BE_ACTION
            git pull origin main

            # 환경변수 파일(.env) 생성 (GitHub Secrets로부터 주입 가능)
            cat > .env << ENV
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            MYSQL_DATABASE=${{ secrets.DEV_DB_NAME }}
            MYSQL_USER=${{ secrets.DEV_DB_USERNAME }}
            MYSQL_PASSWORD=${{ secrets.DEV_DB_PASSWORD }}
            ENV

            # 컨테이너 재빌드·실행
            docker-compose pull
            docker-compose up -d --build
          EOF