#ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: CI/CD Build & Deploy to EC2 (Local Docker build on EC2)

#main branchë¡œ pushí•˜ë©´ ì‹¤í–‰
on:
  push:
    branches:
      - main

#ë°°í¬ ì‘ì—… ì •ì˜
jobs:
  #ubuntu VMì—ì„œ ì‹¤í–‰
  deploy:
    runs-on: ubuntu-latest


    steps:
      #í˜„ì¬ ë ˆí¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ë‚´ë ¤ë°›ìŒ
      - name: Checkout code
        uses: actions/checkout@v4

      #EC2ì— ì ‘ê·¼í•  SSH í‚¤ë¥¼ Github Actionsì— ë“±ë¡
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_ACTIONS_SSH_KEY }}

      ### 3. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission to gradlew
        run: chmod +x ./gradlew

      ### 4. ğŸ—ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build

      #í˜„ì¬ ë””ë ‰í† ë¦¬ ì „ì²´ë¥¼ EC2ë¡œ ë³µì‚¬ (TODO : ì¶”í›„ ë³€ê²½ëœ íŒŒì¼ë§Œ pushë˜ë„ë¡ ìˆ˜ì • í•„ìš”)
      - name: Copy project source code to EC2 (excluding .git, .github)
        run: |
          rsync -avz --exclude='.git' --exclude='.github' -e "ssh -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ubuntu/PICKCAR_BE_ACTION

      #.env íŒŒì¼ì„ EC2 ì„œë²„ ë‚´ì— ì§ì ‘ ìƒì„±
      - name: Create .env file on EC2
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          port: ${{ secrets.EC2_PORT }}
          key: ${{ secrets.EC2_ACTIONS_SSH_KEY }}
          script: |
            cd /home/ubuntu/PICKCAR_BE_ACTION
            cat > .env <<EOL
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            DEV_DB_NAME=${{ secrets.DEV_DB_NAME }}
            DEV_DB_USERNAME=${{ secrets.DEV_DB_USERNAME }}
            DEV_DB_PASSWORD=${{ secrets.DEV_DB_PASSWORD }}
            EOL

      #ë„ì»¤ ì»´í¬ì¦ˆ ë°°í¬(ì „ì²´ ë¹Œë“œ + ì‹¤í–‰)
      #ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ -> ì´ë¯¸ì§€ ë¹Œë“œ -> ì»¨í…Œì´ë„ˆ ì¬ì‹¤í–‰
      - name: Deploy on EC2 (Local Docker Compose build)
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          port: ${{ secrets.EC2_PORT }}
          key: ${{ secrets.EC2_ACTIONS_SSH_KEY }}
          script: |
            set -e
            cd /home/ubuntu/PICKCAR_BE_ACTION/domain/src/main/resources
            rm -f application-dev.yml
            cp application-dev.default application-dev.yml
            echo "application-dev.yml íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
            
            echo "ë„ì»¤ì— up ì‹œì‘"
            cd /home/ubuntu/PICKCAR_BE_ACTION
            sudo docker-compose down
            sudo docker container prune -af
            sudo docker-compose build --no-cache
            sudo docker-compose up -d